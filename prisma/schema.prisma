generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String       @id @default(uuid())
  email            String       @unique
  name             String?
  avatarUrl        String?      @map("avatar_url")
  timezone         String       @default("America/Sao_Paulo")
  defaultWorkHours Float        @default(8.0) @map("default_work_hours")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  clockEntries    ClockEntry[]
  projects        Project[]
  hourBankEntries HourBank[]

  @@map("users")
}

model Project {
  id         String           @id @default(uuid())
  userId     String           @map("user_id")
  name       String
  clientName String?          @map("client_name")
  hourlyRate Decimal?         @map("hourly_rate") @db.Decimal(10, 2)
  color      String           @default("#6366f1")
  isActive   Boolean          @default(true) @map("is_active")
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")

  user        User             @relation(fields: [userId], references: [id])
  allocations TimeAllocation[]

  @@map("projects")
}

model ClockEntry {
  id           String           @id @default(uuid())
  userId       String           @map("user_id")
  clockIn      DateTime         @map("clock_in") @db.Timestamptz
  clockOut     DateTime?        @map("clock_out") @db.Timestamptz
  entryDate    DateTime         @map("entry_date") @db.Date
  totalMinutes Int?             @map("total_minutes")
  notes        String?
  hash         String?
  source       String           @default("web")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  user        User             @relation(fields: [userId], references: [id])
  allocations TimeAllocation[]

  @@index([userId, entryDate])
  @@index([userId, clockIn])
  @@map("clock_entries")
}

model TimeAllocation {
  id           String     @id @default(uuid())
  clockEntryId String     @map("clock_entry_id")
  projectId    String     @map("project_id")
  minutes      Int
  createdAt    DateTime   @default(now()) @map("created_at")

  clockEntry ClockEntry @relation(fields: [clockEntryId], references: [id], onDelete: Cascade)
  project    Project    @relation(fields: [projectId], references: [id])

  @@map("time_allocations")
}

model HourBank {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  month             DateTime @db.Date
  expectedMinutes   Int      @map("expected_minutes")
  actualMinutes     Int      @map("actual_minutes")
  balanceMinutes    Int      @map("balance_minutes")
  cumulativeBalance Int      @map("cumulative_balance")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, month])
  @@map("hour_bank")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  action    String
  entityId  String   @map("entity_id")
  oldData   Json?    @map("old_data")
  newData   Json?    @map("new_data")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("audit_log")
}
